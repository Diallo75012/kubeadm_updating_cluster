# Create Certificates For The Cluster
Go to source Kubernetes Documentation Which Has All Details: [Cert Creation Doc](https://kubernetes.io/docs/tasks/administer-cluster/certificates/)

## Kubeadm when initialized creates certificates automatically
- The certificates generated by kubeadm include:​
    - CA Certificates: These are the root certificates used to sign other certificates within the cluster.​
    - API Server Certificates: Used by the Kubernetes API server to establish secure communications.​
    - Kubelet Client Certificates: Used by the kubelet to authenticate to the API server.​
    - Etcd Certificates: Used for secure communication with the etcd key-value store.​

# KUBEADM ISSUE
- Kubelet not starting
- Certs are all expired for every components: `controller`, `api-server`, `scheduler`, `etcd`

1. Can renew certs using a simple command:
```bash
sudo kubeadm certs check-expiration
kubeadm certs renew all
# OR for specific ones
sudo kubeadm certs renew admin.conf
```

Which will renew the `admin.conf` embedded certs.

2. Embedded certs are base64 encoded
```bash
base64 -w 0 /etc/kubernetes/pki/ca.crt > ca.crt.base64
base64 -w 0 /etc/kubernetes/pki/admin.crt > admin.crt.base64
base64 -w 0 /etc/kubernetes/pki/admin.key > admin.key.base64
base64 -w 0 /etc/kubernetes/pki/apiserver-kubelet-client.crt > apiserver-kubelet-client.crt.base64
base64 -w 0 /etc/kubernetes/pki/apiserver-kubelet-client.key > apiserver-kubelet-client.key.base64
base64 -w 0 /etc/kubernetes/pki/front-proxy-client.crt > front-proxy-client.crt.base64
base64 -w 0 /etc/kubernetes/pki/front-proxy-client.key > front-proxy-client.key.base64
base64 -w 0 /etc/kubernetes/pki/apiserver-etcd-client.crt > apiserver-etcd-client.crt.base64
base64 -w 0 /etc/kubernetes/pki/apiserver-etcd-client.key > apiserver-etcd-client.key.base64
```

- can also manually convert those keys and past those in the configuration files:
eg:.
```bash
cat /etc/kubernetes/pki/apiserver-etcd-client.crt | base64
```

3. Cert can't be found for `admin.conf` in `../pki/..` folder:
Extract Keys from the `admin.conf` file for example to get the cert
- can also install `yq` which is a tool helping from the terminal to fetch `YAML` fields data, eg.:
```bash
sudo add-apt-repository ppa:rmescandon/yq
sudo apt update
sudo apt install yq -y
```
- then use it like that:
```bash
yq e '.users[0].user.client-certificate-data' /etc/kubernetes/admin.conf | base64 -d | sudo tee /etc/kubernetes/pki/admin.crt
```

## **Important**
- **Make Backups of certs and inital `YAML` files**

4. Documentation to understand certificates with some tables:
[Best Practices Kubernetes certificates](https://kubernetes.io/docs/setup/best-practices/certificates/)



# Controller Components Having a `.conf` File (present in `/etc/kubernetes/) Because Need To Authenticate To `Api-Server`

Note: Certs are base64 encoded and embedded directly within the admin.conf file. If needed to be extracted, decode necessary to get original cert back.

1. admin.conf
- Purpose: Provides administrative access to the Kubernetes API server, typically used by cluster administrators.​
- Default Location: /etc/kubernetes/admin.conf​
- Certificate Authority: /etc/kubernetes/pki/ca.crt​
- Client Certificate: Embedded within the admin.conf file under users.user.client-certificate-data​
- Client Key: Embedded within the admin.conf file under users.user.client-key-data​

2. controller-manager.conf
- Purpose: Used by the Kubernetes Controller Manager to authenticate with the API server.​
- Default Location: /etc/kubernetes/controller-manager.conf​
- Certificate Authority: /etc/kubernetes/pki/ca.crt​
- Client Certificate: Embedded within the controller-manager.conf file under users.user.client-certificate-data​
- Client Key: Embedded within the controller-manager.conf file under users.user.client-key-data​

3. scheduler.conf
- Purpose: Utilized by the Kubernetes Scheduler to authenticate with the API server.​
- Default Location: /etc/kubernetes/scheduler.conf​
- Certificate Authority: /etc/kubernetes/pki/ca.crt​
- Client Certificate: Embedded within the scheduler.conf file under users.user.client-certificate-data​
- Client Key: Embedded within the scheduler.conf file under users.user.client-key-data​
 
4. kubelet.conf
- Purpose: Allows the Kubelet agent, which runs on each node, to authenticate with the API server.​
devopscube.com
- Default Location: /etc/kubernetes/kubelet.conf​
- Certificate Authority: /etc/kubernetes/pki/ca.crt​
- Client Certificate: Typically located at /var/lib/kubelet/pki/kubelet-client-current.pem​
- Client Key: Typically located at /var/lib/kubelet/pki/kubelet-client-current.pem​



# Controller Components Without `.conf` file (present in `/etc/kubernetes/manifest/`) Because Need To Always Be Alive (Critical Components)

5. API Server (kube-apiserver):
- Purpose: The API server acts as the central management entity, validating and configuring data for API objects such as pods, services, and replication controllers.​
- Certificate Authority File: /etc/kubernetes/pki/ca.crt​
- Server Certificate and Key Files: /etc/kubernetes/pki/apiserver.crt and /etc/kubernetes/pki/apiserver.key​
- Client Certificates for etcd and kubelet:
  - etcd Client Certificate and Key Files: /etc/kubernetes/pki/apiserver-etcd-client.crt and /etc/kubernetes/pki/apiserver-etcd-client.key
    Description: Used by the API server to authenticate itself to the etcd server.
- kubelet Client Certificate and Key Files: /etc/kubernetes/pki/apiserver-kubelet-client.crt and /etc/kubernetes/pki/apiserver-kubelet-client.key
  Description: Used by the API server to authenticate itself to kubelets.

6. etcd:
- Purpose: etcd is a consistent and highly-available key-value store used as Kubernetes' backing store for all cluster data.​
- Certificate Authority Files: /etc/kubernetes/pki/etcd/ca.crt and /etc/kubernetes/pki/etcd/ca.key​
  Description: The root CA certificate and key for etcd, used to sign etcd server and peer certificates.​
- Server Certificate and Key Files: /etc/kubernetes/pki/etcd/server.crt and /etc/kubernetes/pki/etcd/server.key​
  Description: Used by etcd to serve secure (HTTPS) endpoints.​
- Peer Certificates Files: /etc/kubernetes/pki/etcd/peer.crt and /etc/kubernetes/pki/etcd/peer.key​
  Description: Used for secure communication between etcd peers in a cluster.​
- Client Certificates Files: /etc/kubernetes/pki/etcd/healthcheck-client.crt and /etc/kubernetes/pki/etcd/healthcheck-client.key​
  Description: Used by clients performing health checks on etcd.

# Folder Separation Of Concerns For Cluster-Wide Components and Node Components
## Folder For Cluster-Wide Components
- /etc/kubernetes/pki/ contains cluster-wide control plane certificates (API server, etcd, CA).
## Folder For Node Components
- /var/lib/kubelet/pki/ stores node-specific kubelet certificates.
Here for example the `Kubelet` client certificates will be stored as `Kubelet` on each node need a different key to authenticate to the `Api-Server`
**Here Unique `.pem` File As It Holds `crt` and `key`**: simplifies automatic renewal and storage (one file instead of two)

# `Admin.conf` and `Ca.crt`

1. `Admin.conf`
- `Admin.conf`: is the same file that you are going to find in /home/<admin_user>/.kube/config
```bash
mkdir -p $HOME/.kube
sudo cp /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

2. `Ca.crt` = **Root CA**
- `Ca.crt`: is the **authority** certificate for all the cluster controller components.
- Sign in all clients and server certificates.

`Admin.conf` is which is copied and changed permission to the `admin_user` home directory in `~/.kube/config`
is used by `kubectl` commands to authenticate to the cluster where `Api Server` will use the `Ca.crt` **Authority** to verify signature and permissions.

# excalidraw
(diagram)[https://excalidraw.com/#json=WzZhrHD8yzfZiZpxozspm,kcfadLPL1OpznKFjlzDezA]
